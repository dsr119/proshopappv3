<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Pro Shop ‚Äì To-Do's</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover">

  <style>
    :root {
      --bg: #05070a;
      --card: #10131a;
      --card-soft: #151924;
      --accent: #4da3ff;
      --accent-soft: rgba(77, 163, 255, 0.18);
      --border: #222632;
      --text: #f9fafb;
      --muted: #9ca3af;
      --radius-lg: 16px;
      --radius-sm: 10px;
      --shadow-soft: 0 18px 40px rgba(0,0,0,0.65);
      --success: #4ade80;
      --warning: #facc15;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: radial-gradient(circle at top, #151927 0, #05070a 46%);
      color: var(--text);
    }

    .app { min-height: 100vh; display: flex; flex-direction: column; }

    .app-header {
      padding: 16px 18px 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      position: sticky;
      top: 0;
      z-index: 5;
      background: linear-gradient(to bottom, rgba(5,7,10,0.97), rgba(5,7,10,0.85) 65%, transparent);
      backdrop-filter: blur(12px);
    }

    .app-title-block { display: flex; flex-direction: column; gap: 2px; }

    .app-title { font-size: 20px; font-weight: 600; letter-spacing: 0.02em; }

    .app-subtitle { font-size: 12px; color: var(--muted); }

    .pill {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.25);
      color: var(--muted);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(15,23,42,0.7);
    }

    .pill-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 5px rgba(34,197,94,0.25);
    }

    .app-main {
      flex: 1;
      padding: 0 16px 90px;
      max-width: 520px;
      width: 100%;
      margin: 0 auto;
    }

    .card {
      background: radial-gradient(circle at top left, rgba(77,163,255,0.08), rgba(15,23,42,0.65), #05070a);
      border-radius: var(--radius-lg);
      border: 1px solid rgba(15,23,42,0.9);
      box-shadow: var(--shadow-soft);
      padding: 14px 14px 12px;
      margin-bottom: 14px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 10px;
      gap: 8px;
    }

    .card-title {
      font-size: 14px;
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }

    .card-subtitle {
      font-size: 11px;
      color: var(--muted);
    }

    /* Search bar */
    .search-wrap { margin-top: 4px; }

    .search-input {
      width: 100%;
      padding: 9px 11px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(15,23,42,0.9);
      color: var(--text);
      font-size: 14px;
    }

    .search-input::placeholder { color: #6b7280; }

    .search-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent-soft);
      background: rgba(15,23,42,0.95);
    }

    .search-meta {
      margin-top: 6px;
      font-size: 11px;
      color: var(--muted);
    }

    /* To-Do List */
    .order-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .order-empty {
      font-size: 12px;
      color: var(--muted);
    }

    .order-card {
      border-radius: 14px;
      border: 1px solid rgba(31,41,55,0.9);
      background: rgba(15,23,42,0.98);
      padding: 10px 11px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .order-header-main {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
    }

    .order-name { font-size: 14px; font-weight: 600; }

    .order-phone { font-size: 11px; color: var(--muted); }

    .order-due-pill {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.35);
      background: rgba(15,23,42,0.9);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .due-label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
    }

    .due-date { font-weight: 500; }

    .status-badge-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 4px;
    }

    .status-badge {
      font-size: 10px;
      padding: 3px 9px;
      border-radius: 999px;
      border: 1px solid rgba(75,85,99,0.9);
      background: #020617;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      cursor: pointer;
      user-select: none;
    }

    .status-badge.on {
      border-color: rgba(74,222,128,0.9);
      color: var(--success);
      background: rgba(22,163,74,0.12);
    }

    .status-badge.off {
      border-color: rgba(148,163,184,0.7);
      color: #9ca3af;
      background: rgba(15,23,42,0.9);
    }

    .order-body { font-size: 12px; color: var(--muted); }

    .order-body strong { color: var(--text); font-weight: 500; }

    .order-meta-row { font-size: 11px; color: var(--muted); }

    /* Action buttons */
    .card-actions {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      margin-top: 6px;
    }

    .btn-small {
      flex: 1;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(75,85,99,0.9);
      background: #020617;
      color: #e5e7eb;
      font-size: 11px;
      font-weight: 500;
      text-align: center;
      cursor: pointer;
    }

    .btn-small.primary {
      border-color: var(--accent);
      background: linear-gradient(to bottom right, #60a5fa, #2563eb);
      color: white;
    }

    .btn-small:active {
      transform: translateY(1px);
      box-shadow: 0 6px 14px rgba(0,0,0,0.6);
    }

    /* Footer */
    .app-footer {
      position: sticky;
      bottom: 0;
      background: rgba(5,7,10,0.97);
      padding-top: 6px;
    }

    .footer-inner {
      max-width: 520px;
      margin: 0 auto;
      padding: 0 16px 10px;
    }

    .bottom-nav { border-top: 1px solid #2d3543; padding-top: 6px; }
    .bottom-nav-row { display: flex; justify-content: space-between; }

    .nav-item {
      flex: 1;
      text-align: center;
      font-size: 10px;
      color: var(--muted);
      padding: 6px 0;
    }

    .nav-item-active { color: #e5e7eb; }

    .nav-icon {
      width: 22px; height: 22px;
      border-radius: 50%;
      border: 1px solid #4b5563;
      display: flex; justify-content: center; align-items: center;
      margin: 0 auto 2px;
    }

    .nav-item-active .nav-icon {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent-soft);
    }

    /* Modal for Make Appt */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.88);
      backdrop-filter: blur(10px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    .modal-backdrop.show {
      display: flex;
    }

    .modal {
      width: 100%;
      max-width: 420px;
      background: #020617;
      border-radius: 18px;
      border: 1px solid rgba(148,163,184,0.35);
      box-shadow: 0 24px 60px rgba(0,0,0,0.85);
      padding: 14px 16px 16px;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
    }

    .modal-title {
      font-size: 15px;
      font-weight: 600;
    }

    .modal-subtitle {
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 8px;
    }

    .modal-close {
      border: none;
      background: transparent;
      color: var(--muted);
      font-size: 18px;
      cursor: pointer;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 8px;
    }

    .field-label {
      font-size: 11px;
      font-weight: 500;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .field-input,
    .field-select {
      width: 100%;
      padding: 9px 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(15,23,42,0.95);
      color: var(--text);
      font-size: 14px;
    }

    .field-input:focus,
    .field-select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent-soft);
      outline: none;
    }

    .modal-actions {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }

    .btn-outline {
      flex: 1;
      padding: 9px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.7);
      background: transparent;
      color: #e5e7eb;
      font-size: 13px;
      cursor: pointer;
      text-align: center;
    }

    .btn-primary-lg {
      flex: 1;
      padding: 9px 10px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(to bottom right, #60a5fa, #2563eb);
      color: #fff;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      text-align: center;
    }

    .bottom-nav { border-top: 1px solid #2d3543; padding-top: 6px; }
.bottom-nav-row { display: flex; justify-content: space-between; }

.nav-item {
  flex: 1;
  display: flex;              /* make the whole thing clickable */
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 2px;
  text-align: center;
  font-size: 10px;
  color: var(--muted);
  padding: 6px 0;
  text-decoration: none;      /* remove blue underline */
}

.nav-item-active { color: #e5e7eb; }

.nav-icon {
  width: 22px; height: 22px;
  border-radius: 50%;
  border: 1px solid #4b5563;
  display: flex; justify-content: center; align-items: center;
  margin: 0 auto 2px;
}

.nav-item-active .nav-icon {
  border-color: var(--accent);
  box-shadow: 0 0 0 1px var(--accent-soft);
}


  </style>
</head>
<body>
  <div class="app">

    <header class="app-header">
      <div class="app-title-block">
        <div class="app-title">To-Do‚Äôs</div>
        <div class="app-subtitle">All active shop work ‚Äî orders + services</div>
      </div>
      <div class="pill">
        <span class="pill-dot"></span>
        Live queue
      </div>
    </header>

    <main class="app-main">

      <!-- SEARCH CARD -->
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Search To-Do‚Äôs</div>
            <div class="card-subtitle">Search by name, number, item, location, dates, staff‚Ä¶</div>
          </div>
        </div>
        <div class="search-wrap">
          <input
            id="todoSearch"
            class="search-input"
            type="text"
            placeholder="Start typing a name, phone, or item‚Ä¶"
          />
          <div class="search-meta" id="searchMeta">Loading items‚Ä¶</div>
        </div>
      </section>

      <!-- TO-DO LIST CARD -->
      <section class="card">
        <div class="card-header">
          <div>
            <div class="card-title">Active To-Do‚Äôs</div>
            <div class="card-subtitle" id="listSubtitle">Newest first ‚Ä¢ All locations</div>
          </div>
        </div>

        <div id="orderList" class="order-list">
          <!-- Populated by JS -->
        </div>
      </section>

    </main>

    <footer class="app-footer">
      <div class="footer-inner">
        <nav class="bottom-nav">
          <div class="bottom-nav-row">
    
            <a href="https://sites.google.com/view/proshopappv3/orderpage"
               class="nav-item">
              <div class="nav-icon">üßæ</div>
              Orders
            </a>
    
            <a href="https://sites.google.com/view/proshopappv3/servicepage"
               class="nav-item">
              <div class="nav-icon">üõ†Ô∏è</div>
              Services
            </a>
    
            <a href="https://sites.google.com/view/proshopappv3/todopage"
               class="nav-item nav-item-active">
              <div class="nav-icon">üìã</div>
              To-Do's
            </a>
    
            <a href="https://sites.google.com/view/proshopappv3/apptpage"
               class="nav-item">
              <div class="nav-icon">üìÖ</div>
              Appts
            </a>
    
          </div>
        </nav>
      </div>
    </footer>
    
    
    

  </div>

  <!-- Make Appointment Modal -->
  <div id="apptModalBackdrop" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">Schedule Appointment</div>
        <button class="modal-close" id="apptModalCloseBtn">&times;</button>
      </div>
      <div class="modal-subtitle">Create an appointment from this To-Do item.</div>

      <div class="field">
        <label class="field-label" for="modalApptName">Customer Name</label>
        <input id="modalApptName" type="text" class="field-input" />
      </div>

      <div class="field">
        <label class="field-label" for="modalApptPhone">Phone Number</label>
        <input id="modalApptPhone" type="text" class="field-input" />
      </div>

      <div class="field">
        <label class="field-label" for="modalApptService">Service / Item</label>
        <input id="modalApptService" type="text" class="field-input" />
      </div>

      <div class="field">
        <label class="field-label" for="modalApptDate">Date</label>
        <input id="modalApptDate" type="date" class="field-input" />
      </div>

      <div class="field">
        <label class="field-label" for="modalApptLocation">Location</label>
        <select id="modalApptLocation" class="field-select">
          <option value="">Select location</option>
          <option value="Valley Lanes">Valley Lanes</option>
          <option value="Idle Hours South">Idle Hours South</option>
        </select>
      </div>

      <div class="field">
        <label class="field-label" for="modalApptTime">Time</label>
        <select id="modalApptTime" class="field-select">
          <option value="">Select time</option>
          <option>6:00 PM</option>
          <option>6:15 PM</option>
          <option>6:30 PM</option>
          <option>6:45 PM</option>
          <option>7:00 PM</option>
          <option>7:15 PM</option>
          <option>7:30 PM</option>
          <option>7:45 PM</option>
          <option>8:00 PM</option>
          <option>8:15 PM</option>
          <option>8:30 PM</option>
          <option>8:45 PM</option>
          <option>9:00 PM</option>
        </select>
      </div>

      <div class="modal-actions">
        <button class="btn-outline" type="button" id="apptModalCancelBtn">Cancel</button>
        <button class="btn-primary-lg" type="button" id="apptModalSaveBtn">Save Appointment</button>
      </div>
    </div>
  </div>

  <script>
    // üîó To-Do web app URL (for reading + flag updates)
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzSbKxv1vHtfpFj23VZ7OcAh6Ea8t8k-gkyA9zIS-ckpV9V8tojMt_vCpaPd-95Uk8t/exec';

    // üîó Appointment web app URL (same as your main appointment page)
    const APPT_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxpLY1EXauimDjj5eymprO4QjHIZgvy4I6_Ug-i8deC3UWgi1vH3PRoIuANALQmZyJDlQ/exec';

    let ALL_ITEMS = [];
    let LAST_QUERY = '';
    let CURRENT_APPT_ITEM = null; // the item we‚Äôre making an appt for

    function renderTodos(filterText = '') {
      const listEl = document.getElementById('orderList');
      const searchMeta = document.getElementById('searchMeta');
      const query = filterText.trim().toLowerCase();
      LAST_QUERY = filterText;

      listEl.innerHTML = '';

      if (!ALL_ITEMS.length) {
        searchMeta.textContent = 'No items loaded.';
        const empty = document.createElement('div');
        empty.className = 'order-empty';
        empty.textContent = 'Nothing in the To-Do sheet yet.';
        listEl.appendChild(empty);
        return;
      }

      const filtered = ALL_ITEMS.filter(item => {
        if (!query) return true;
        const haystack = [
          item.name,
          item.phone,
          item.itemDescription,
          item.location,
          item.orderDue,
          item.orderDate,
          item.staffMember
        ].join(' ').toLowerCase();
        return haystack.includes(query);
      });

      if (!query) {
        searchMeta.textContent = `Showing all items (${filtered.length})`;
      } else {
        searchMeta.textContent = `Showing ${filtered.length} match${filtered.length === 1 ? '' : 'es'} for ‚Äú${filterText}‚Äù`;
      }

      if (!filtered.length) {
        const empty = document.createElement('div');
        empty.className = 'order-empty';
        empty.textContent = 'No items match your search.';
        listEl.appendChild(empty);
        return;
      }

      filtered.forEach(item => {
        const paid      = (item.customerPaid   || '').toUpperCase() === 'Y';
        const completed = (item.completed      || '').toUpperCase() === 'Y';
        const called    = (item.hasBeenCalled  || '').toUpperCase() === 'Y';

        const card = document.createElement('div');
        card.className = 'order-card';
        card.dataset.id = item.id || '';

        const headerMain = document.createElement('div');
        headerMain.className = 'order-header-main';
        headerMain.innerHTML = `
          <div>
            <div class="order-name">${item.name || 'Unknown'}</div>
            <div class="order-phone">${item.phone || ''}</div>
          </div>
          <div class="order-due-pill">
            <span class="due-label">Due</span>
            <span class="due-date">${item.orderDue || '-'}</span>
          </div>
        `;
        card.appendChild(headerMain);

        const badgeRow = document.createElement('div');
        badgeRow.className = 'status-badge-row';

        const paidBadge = document.createElement('span');
        paidBadge.className = 'status-badge ' + (paid ? 'on' : 'off');
        paidBadge.dataset.type = 'paid';
        paidBadge.textContent = paid ? 'Paid' : 'Unpaid';
        badgeRow.appendChild(paidBadge);

        const completeBadge = document.createElement('span');
        completeBadge.className = 'status-badge ' + (completed ? 'on' : 'off');
        completeBadge.dataset.type = 'completed';
        completeBadge.textContent = completed ? 'Complete' : 'Incomplete';
        badgeRow.appendChild(completeBadge);

        const calledBadge = document.createElement('span');
        calledBadge.className = 'status-badge ' + (called ? 'on' : 'off');
        calledBadge.dataset.type = 'called';
        calledBadge.textContent = called ? 'Called' : 'Not Called';
        badgeRow.appendChild(calledBadge);

        card.appendChild(badgeRow);

        const body = document.createElement('div');
        body.className = 'order-body';
        body.innerHTML = `
          <strong>${item.itemDescription || ''}</strong><br>
          ${item.location || ''}${item.orderDate ? ' ‚Ä¢ Ordered ' + item.orderDate : ''}
        `;
        card.appendChild(body);

        const metaRow = document.createElement('div');
        metaRow.className = 'order-meta-row';
        metaRow.textContent = `Staff: ${item.staffMember || '‚Äî'}`;
        card.appendChild(metaRow);

        const actions = document.createElement('div');
        actions.className = 'card-actions';
        actions.innerHTML = `
          <button class="btn-small" data-action="edit">Edit</button>
          <button class="btn-small" data-action="appt">Make Appt</button>
          <button class="btn-small primary" data-action="out">Mark Out The Door</button>
        `;
        card.appendChild(actions);

        listEl.appendChild(card);
      });
    }

    async function loadTodosFromServer() {
      const searchMeta = document.getElementById('searchMeta');
      const listEl = document.getElementById('orderList');

      if (!WEB_APP_URL || !WEB_APP_URL.startsWith('https://')) {
        searchMeta.textContent = 'Web app URL not set.';
        listEl.innerHTML = '<div class="order-empty">Set WEB_APP_URL in the script tag.</div>';
        return;
      }

      searchMeta.textContent = 'Loading items‚Ä¶';

      try {
        const res = await fetch(WEB_APP_URL);
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        if (!data.success) throw new Error(data.error || 'Unknown server error');

        ALL_ITEMS = data.items || [];
        renderTodos(LAST_QUERY);
      } catch (err) {
        console.error(err);
        searchMeta.textContent = 'Failed to load items.';
        listEl.innerHTML = '<div class="order-empty">Error loading To-Do list.</div>';
      }
    }

    function updateLocalItemFlag(id, fieldKey, value) {
      const item = ALL_ITEMS.find(i => (i.id || '').toString() === id);
      if (!item) return;
      if (fieldKey === 'paid')      item.customerPaid    = value;
      if (fieldKey === 'out')       item.orderOutTheDoor = value;
      if (fieldKey === 'called')    item.hasBeenCalled   = value;
      if (fieldKey === 'completed') item.completed       = value;
    }

    function sendFlagUpdate(id, fieldKey, value) {
      if (!WEB_APP_URL || !WEB_APP_URL.startsWith('https://')) return;
      fetch(WEB_APP_URL, {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify({
          action: 'updateFlag',
          id,
          fieldKey,
          value
        })
      }).catch(err => console.error('Flag update error:', err));
    }

    function openApptModal(item) {
      CURRENT_APPT_ITEM = item || null;
      const backdrop = document.getElementById('apptModalBackdrop');

      document.getElementById('modalApptName').value    = item?.name || '';
      document.getElementById('modalApptPhone').value   = item?.phone || '';
      document.getElementById('modalApptService').value = item?.itemDescription || '';

      // Clear date/time/location each time
      document.getElementById('modalApptDate').value     = '';
      document.getElementById('modalApptLocation').value = '';
      document.getElementById('modalApptTime').value     = '';

      backdrop.classList.add('show');
    }

    function closeApptModal() {
      const backdrop = document.getElementById('apptModalBackdrop');
      backdrop.classList.remove('show');
      CURRENT_APPT_ITEM = null;
    }

    async function handleApptSave() {
      if (!APPT_WEB_APP_URL || !APPT_WEB_APP_URL.startsWith('https://')) {
        alert('Appointment web app URL not set.');
        return;
      }

      const name     = document.getElementById('modalApptName').value.trim();
      const phone    = document.getElementById('modalApptPhone').value.trim();
      const service  = document.getElementById('modalApptService').value.trim();
      const apptDate = document.getElementById('modalApptDate').value; // YYYY-MM-DD
      const location = document.getElementById('modalApptLocation').value;
      const apptTime = document.getElementById('modalApptTime').value;

      if (!name || !phone || !service || !apptDate || !location || !apptTime) {
        alert('Please fill in all fields before saving the appointment.');
        return;
      }

      const payload = { name, phone, service, apptDate, location, apptTime };

      try {
        await fetch(APPT_WEB_APP_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'text/plain;charset=utf-8' },
          body: JSON.stringify(payload)
        });

        alert('Appointment saved!');
        closeApptModal();
      } catch (err) {
        console.error(err);
        alert('Failed to save appointment: ' + err.message);
      }
    }

    function setupInteractions() {
      const listEl = document.getElementById('orderList');
      const searchInput = document.getElementById('todoSearch');

      searchInput.addEventListener('input', e => {
        renderTodos(e.target.value);
      });

      listEl.addEventListener('click', e => {
        const badge = e.target.closest('.status-badge');
        if (badge) {
          const card = badge.closest('.order-card');
          const id = card ? card.dataset.id : '';
          const type = badge.dataset.type;
          const isOn = badge.classList.contains('on');
          const newVal = isOn ? 'N' : 'Y';

          badge.classList.toggle('on', !isOn);
          badge.classList.toggle('off', isOn);

          if (type === 'paid') {
            badge.textContent = isOn ? 'Unpaid' : 'Paid';
            updateLocalItemFlag(id, 'paid', newVal);
            sendFlagUpdate(id, 'paid', newVal);
          } else if (type === 'completed') {
            badge.textContent = isOn ? 'Incomplete' : 'Complete';
            updateLocalItemFlag(id, 'completed', newVal);
            sendFlagUpdate(id, 'completed', newVal);
          } else if (type === 'called') {
            badge.textContent = isOn ? 'Not Called' : 'Called';
            updateLocalItemFlag(id, 'called', newVal);
            sendFlagUpdate(id, 'called', newVal);
          }
          return;
        }

        const btn = e.target.closest('.btn-small');
        if (btn) {
          const action = btn.dataset.action;
          const card = btn.closest('.order-card');
          const id = card ? card.dataset.id : '';
          const item = ALL_ITEMS.find(i => (i.id || '').toString() === id);

          if (action === 'edit') {
            alert('Edit clicked for ID: ' + id);
          } else if (action === 'appt') {
            if (!item) {
              alert('Could not find this item to prefill appointment.');
              return;
            }
            openApptModal(item);
          } else if (action === 'out') {
            const current = (item && item.orderOutTheDoor || '').toUpperCase() === 'Y';
            const newVal = current ? 'N' : 'Y';
            updateLocalItemFlag(id, 'out', newVal);
            sendFlagUpdate(id, 'out', newVal);
            btn.textContent = current ? 'Mark Out The Door' : 'Undo Out The Door';
          }
        }
      });

      // Modal buttons
      document.getElementById('apptModalCloseBtn')
        .addEventListener('click', closeApptModal);
      document.getElementById('apptModalCancelBtn')
        .addEventListener('click', closeApptModal);
      document.getElementById('apptModalSaveBtn')
        .addEventListener('click', handleApptSave);

      // Close modal on backdrop click (outside the modal card)
      document.getElementById('apptModalBackdrop')
        .addEventListener('click', e => {
          if (e.target.id === 'apptModalBackdrop') {
            closeApptModal();
          }
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
      setupInteractions();
      loadTodosFromServer();
    });
  </script>
</body>
</html>
