<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Pro Shop ‚Äì To-Do List</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover">

  <style>
  :root {
    --bg: #05070a;
    --card: #10131a;
    --card-soft: #151924;
    --accent: #4da3ff;
    --accent-soft: rgba(77,163,255,0.18);
    --border: #222632;
    --text: #f9fafb;
    --muted: #9ca3af;
    --radius-lg: 16px;
    --radius-sm: 10px;
    --shadow-soft: 0 18px 40px rgba(0,0,0,0.65);

    /* Badge colors */
    --badge-on-bg: rgba(34,197,94,0.15);
    --badge-on-border: rgba(34,197,94,0.7);
    --badge-on-text: #bbf7d0;

    --badge-off-bg: rgba(148,163,184,0.12);
    --badge-off-border: rgba(148,163,184,0.5);
    --badge-off-text: #9ca3af;

    --danger-bg: rgba(248,113,113,0.1);
    --danger-border: rgba(248,113,113,0.7);
    --danger-text: #fecaca;
  }

  * {
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
  }

  body {
    margin: 0;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    background: radial-gradient(circle at top, #151927 0, #05070a 46%);
    color: var(--text);
  }

  .app {
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }

  .app-header {
    padding: 16px 18px 10px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    position: sticky;
    top: 0;
    z-index: 5;
    background: linear-gradient(to bottom, rgba(5,7,10,0.97), rgba(5,7,10,0.9) 65%, transparent);
    backdrop-filter: blur(12px);
  }

  .header-top-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 10px;
  }

  .app-title-block {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .app-title {
    font-size: 20px;
    font-weight: 600;
    letter-spacing: 0.02em;
  }

  .app-subtitle {
    font-size: 12px;
    color: var(--muted);
  }

  .pill {
    font-size: 11px;
    padding: 4px 10px;
    border-radius: 999px;
    border: 1px solid rgba(148,163,184,0.25);
    color: var(--muted);
    display: inline-flex;
    align-items: center;
    gap: 6px;
    background: rgba(15,23,42,0.7);
    white-space: nowrap;
  }

  .pill-dot {
    width: 7px;
    height: 7px;
    border-radius: 999px;
    background: #22c55e;
    box-shadow: 0 0 0 5px rgba(34,197,94,0.25);
  }

  .search-row {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .search-input {
    flex: 1;
    padding: 8px 10px;
    border-radius: 999px;
    border: 1px solid var(--border);
    background: rgba(15,23,42,0.9);
    color: var(--text);
    font-size: 13px;
    outline: none;
  }

  .search-input::placeholder {
    color: rgba(148,163,184,0.9);
  }

  .filter-pill {
    font-size: 11px;
    padding: 6px 10px;
    border-radius: 999px;
    border: 1px solid rgba(148,163,184,0.35);
    color: var(--muted);
    background: rgba(15,23,42,0.9);
    cursor: pointer;
    white-space: nowrap;
  }

  .filter-pill-active {
    border-color: var(--accent);
    color: #bfdbfe;
    background: rgba(37,99,235,0.16);
  }

  .app-main {
    flex: 1;
    padding: 8px 16px 90px;
    max-width: 520px;
    width: 100%;
    margin: 0 auto;
  }

  .section-label {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.16em;
    color: var(--muted);
    margin: 6px 4px 8px;
  }

  .list-empty {
    font-size: 13px;
    color: var(--muted);
    text-align: center;
    padding: 30px 16px;
  }

  .list-empty strong {
    color: #e5e7eb;
  }

  .card {
    background: radial-gradient(circle at top left, rgba(77,163,255,0.09) 0, rgba(15,23,42,0.9) 26%, #05070a 100%);
    border-radius: var(--radius-lg);
    border: 1px solid rgba(15,23,42,0.9);
    box-shadow: var(--shadow-soft);
    padding: 12px 12px 10px;
    margin-bottom: 10px;
  }

  .card-header-row {
    display: block;
    margin-bottom: 6px;
  }

  .card-name-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 8px;
  }

  .card-name {
    font-size: 15px;
    font-weight: 600;
    text-overflow: ellipsis;
    white-space: nowrap;
    overflow: hidden;
  }

  .badge-inline {
    display: flex;
    gap: 6px;
    flex-wrap: nowrap;
  }

  /* NEW CLEAN BADGE SYSTEM */
  .status-badge {
    font-size: 11px;
    padding: 4px 9px;
    border-radius: 999px;
    border-width: 1px;
    border-style: solid;
    display: inline-flex;
    align-items: center;
    gap: 4px;
    cursor: pointer;
    user-select: none;
    transition: background 0.15s ease, border-color 0.15s ease, color 0.15s ease;
  }

  .status-badge.on {
    background: var(--badge-on-bg);
    border-color: var(--badge-on-border);
    color: var(--badge-on-text);
  }

  .status-badge.off {
    background: var(--badge-off-bg);
    border-color: var(--badge-off-border);
    color: var(--badge-off-text);
  }

  .status-dot {
    width: 7px;
    height: 7px;
    border-radius: 999px;
    background: currentColor;
    opacity: 0.9;
  }

  .card-phone {
    font-size: 12px;
    color: var(--muted);
    margin-top: 2px;
  }

  .card-tag-col {
    margin-top: 6px;
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
  }

  .chip {
    font-size: 11px;
    padding: 3px 8px;
    border-radius: 999px;
    border: 1px solid rgba(148,163,184,0.35);
    color: var(--muted);
    background: rgba(15,23,42,0.9);
    white-space: nowrap;
  }

  .chip-type {
    text-transform: uppercase;
    letter-spacing: 0.12em;
    font-weight: 500;
  }

  .chip-due {
    display: inline-flex;
    align-items: center;
    gap: 4px;
  }

  .chip-due-late {
    border-color: var(--danger-border);
    color: var(--danger-text);
    background: var(--danger-bg);
  }

  .chip-dot {
    width: 6px;
    height: 6px;
    border-radius: 999px;
    background: var(--accent);
  }

  .card-body {
    font-size: 13px;
    margin-bottom: 6px;
  }

  .item-desc {
    margin-bottom: 6px;
    color: #e5e7eb;
  }

  .meta-row {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    font-size: 11px;
    color: var(--muted);
  }

  .meta-pill {
    padding: 3px 7px;
    border-radius: 999px;
    border: 1px solid rgba(31,41,55,0.9);
    background: rgba(15,23,42,0.9);
  }

  .card-footer-row {
    margin-top: 10px;
  }

  .btn-row {
    display: flex;
    gap: 6px;
    width: 100%;
  }

  .btn-wide {
    flex: 1;
    text-align: center;
  }

  .btn-ghost {
    font-size: 11px;
    padding: 6px 10px;
    border-radius: 999px;
    border: 1px solid rgba(148,163,184,0.55);
    background: rgba(15,23,42,0.9);
    color: #e5e7eb;
    cursor: pointer;
    white-space: nowrap;
  }

  .btn-ghost-danger {
    border-color: var(--danger-border);
    color: var(--danger-text);
    background: var(--danger-bg);
  }

  .loading-bar {
    height: 2px;
    width: 100%;
    border-radius: 999px;
    overflow: hidden;
    background: rgba(15,23,42,0.95);
    margin-top: 4px;
    display: none;
  }

  .loading-bar-inner {
    width: 40%;
    height: 100%;
    background: linear-gradient(to right, #60a5fa, #2563eb);
    animation: loadingBar 1s infinite linear;
  }

  @keyframes loadingBar {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(200%); }
  }

  .error-banner {
    display: none;
    margin-top: 6px;
    padding: 6px 8px;
    border-radius: 8px;
    font-size: 11px;
    background: rgba(248,113,113,0.14);
    border: 1px solid rgba(248,113,113,0.7);
    color: #fecaca;
  }

  /* Bottom Navigation */
  .app-footer {
    position: sticky;
    bottom: 0;
    background: #0c0f16;
    padding: 8px 0 4px;
    border-top: 1px solid rgba(255,255,255,0.08);
    backdrop-filter: blur(10px);
    z-index: 10;
  }

  .footer-inner {
    max-width: 520px;
    margin: 0 auto;
    padding: 0 12px 6px;
  }

  .bottom-nav {
    width: 100%;
  }

  .bottom-nav-row {
    display: flex;
    justify-content: space-between;
  }

  .nav-item {
    flex: 1;
    text-align: center;
    padding: 10px 0 6px;
    text-decoration: none;
    color: var(--muted);
    font-size: 11px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
    border-radius: 10px;
    transition: 0.25s ease;
  }

  .nav-item:hover {
    background: rgba(255,255,255,0.04);
  }

  .nav-item-active {
    color: var(--accent);
    font-weight: 600;
  }

  .nav-icon {
    width: 28px;
    height: 28px;
    border: 2px solid rgba(255,255,255,0.1);
    border-radius: 10px;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 15px;
    transition: 0.25s ease;
  }

  .nav-item-active .nav-icon {
    border-color: var(--accent);
    background: rgba(77,163,255,0.12);
    box-shadow: 0 0 8px rgba(77,163,255,0.4);
  }

  @media (min-width: 540px) {
    .app-header { padding-inline: 22px; }
    .app-main { padding-inline: 22px; }
    .footer-inner { padding-inline: 22px; }
  }

  /* Global typography tuning */
body {
  font-size: 15px;          /* was 13‚Äì14 depending on element */
  line-height: 1.25;        /* slight spacing boost */
  letter-spacing: 0.01em;   /* subtle text breathing room */
}

/* Make card text slightly bigger */
.card-body,
.item-desc,
.card-phone,
.meta-row,
.meta-pill {
  font-size: 14px;
  line-height: 1.28;
}

/* Increase name + header readability */
.card-name {
  font-size: 16px;
  letter-spacing: 0.01em;
  line-height: 1.25;
}

/* Buttons slightly bigger text */
.btn-ghost,
.btn-ghost-danger {
  font-size: 12px;
  line-height: 1.25;
}

/* Badges slightly larger and readable */
.status-badge {
  font-size: 12px;
  line-height: 1.2;
}

    /* --- Appointment Modal --- */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.82);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 40;
    }

    .modal-backdrop.show {
      display: flex;
    }

    .modal {
      width: 100%;
      max-width: 420px;
      background: #020617;
      border-radius: 16px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow-soft);
      padding: 14px 14px 12px;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .modal-title {
      font-size: 15px;
      font-weight: 600;
    }

    .modal-close {
      border: none;
      background: transparent;
      color: var(--muted);
      font-size: 18px;
      cursor: pointer;
    }

    .modal-body {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 10px;
    }

    .modal-field {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .modal-field-label {
      font-size: 11px;
      color: var(--muted);
    }

    .modal-field-input {
      width: 100%;
      padding: 8px 9px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(15,23,42,0.9);
      color: var(--text);
      font-size: 13px;
      outline: none;
    }

    .modal-field-input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent-soft);
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    .btn-primary-modal {
      border-color: var(--accent);
      color: #e5e7eb;
    }


</style>

   
</head>

<body>
  <div class="app">
    <header class="app-header">
      <div class="header-top-row">
        <div class="app-title-block">
          <div class="app-title">To-Do Queue</div>
          <div class="app-subtitle">Open orders & services from all sheets.</div>
        </div>
        <div class="pill">
          <span class="pill-dot"></span>
          Live from Sheets
        </div>
      </div>

      <div class="search-row">
        <input id="searchInput" type="text" class="search-input" placeholder="Search by name, phone, item..." />
        <button id="filterOpenBtn" class="filter-pill filter-pill-active" type="button">
          Open Only
        </button>
      </div>

      <div class="loading-bar" id="loadingBar">
        <div class="loading-bar-inner"></div>
      </div>
      <div class="error-banner" id="errorBanner">
        Could not load data from the server. Check the web app URL or deployment.
      </div>
    </header>

    <main class="app-main">
      <div class="section-label">Today‚Äôs work</div>
      <div id="todoList"></div>
    </main>

    <footer class="app-footer">
      <div class="footer-inner">
        <nav class="bottom-nav">
          <div class="bottom-nav-row">

            <a href="orderPage.html" class="nav-item">
              <div class="nav-icon">üßæ</div>
              Orders
            </a>

            <a href="servicePage.html" class="nav-item">
              <div class="nav-icon">üõ†Ô∏è</div>
              Services
            </a>

            <a href="index.html" class="nav-item nav-item-active">
              <div class="nav-icon">üìã</div>
              To-Do's
            </a>

            <a href="appPage.html" class="nav-item">
              <div the="nav-icon">üìÖ</div>
              Appts
            </a>

          </div>
        </nav>
      </div>
    </footer>
  </div>

    <!-- Appointment Modal -->
    <div id="apptModal" class="modal-backdrop" aria-hidden="true">
      <div class="modal">
        <div class="modal-header">
          <div class="modal-title">Schedule Appointment</div>
          <button type="button" class="modal-close" id="apptClose">‚úï</button>
        </div>

        <div class="modal-body">
          <div class="modal-field">
            <label class="modal-field-label" for="apptName">Name</label>
            <input id="apptName" type="text" class="modal-field-input" />
          </div>

          <div class="modal-field">
            <label class="modal-field-label" for="apptPhone">Phone Number</label>
            <input id="apptPhone" type="tel" class="modal-field-input" />
          </div>

          <div class="modal-field">
            <label class="modal-field-label" for="apptService">Service</label>
            <input id="apptService" type="text" class="modal-field-input" />
          </div>

          <div class="modal-field">
            <label class="modal-field-label" for="apptLocation">Location</label>
            <input id="apptLocation" type="text" class="modal-field-input" />
          </div>

          <div class="modal-field">
            <label class="modal-field-label" for="apptDate">Appt Date</label>
            <input id="apptDate" type="date" class="modal-field-input" />
          </div>

          <div class="modal-field">
            <label class="modal-field-label" for="apptTime">Appt Time</label>
            <input id="apptTime" type="text" class="modal-field-input" placeholder="7:00 PM" />
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn-ghost" id="apptCancel">Cancel</button>
          <button type="button" class="btn-ghost btn-primary-modal" id="apptSave">
            Save Appointment
          </button>
        </div>
      </div>
    </div>


  <!-- SCRIPT BELOW -->

  <script>
  // üîó Your deployed Apps Script web app URL ( /exec )
  const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwYk8Hij1VKlqZWmG-jUdVhUNu6CQrPAnt0UH9MWNTpOuHvT0JZ_9zoS4ikVzNWEMva/exec';

  let ALL_ITEMS = [];
  let SHOW_OPEN_ONLY = true;
  let LAST_SEARCH = '';
    let CURRENT_APPT_ITEM = null;


  function normalizeBool(val) {
    const s = (val || '').toString().trim().toUpperCase();
    return s === 'Y' || s === 'YES' || s === 'TRUE' || s === '1';
  }

  function parseDate(val) {
    if (!val) return null;
    const parts = val.split('/');
    if (parts.length === 3) {
      const m = parseInt(parts[0], 10) - 1;
      const d = parseInt(parts[1], 10);
      const y = parseInt(parts[2], 10);
      const dt = new Date(y, m, d);
      return isNaN(dt.getTime()) ? null : dt;
    }
    const dt = new Date(val);
    return isNaN(dt.getTime()) ? null : dt;
  }

    function formatDateDisplay(val) {
    if (!val) return '';
    const d = parseDate(val);
    if (!d) return (val || '').toString();   // fallback if it's some weird text
    return d.toLocaleDateString('en-US', {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit'
    });
  }


  function isOverdue(dateStr) {
    const d = parseDate(dateStr);
    if (!d) return false;
    const today = new Date();
    today.setHours(0,0,0,0);
    d.setHours(0,0,0,0);
    return d < today;
  }

  function setLoading(isLoading) {
    const bar = document.getElementById('loadingBar');
    if (!bar) return;
    bar.style.display = isLoading ? 'block' : 'none';
  }

  function showError(show) {
    const el = document.getElementById('errorBanner');
    if (!el) return;
    el.style.display = show ? 'block' : 'none';
  }

  async function loadTodosFromServer() {
    setLoading(true);
    showError(false);

    try {
      const res = await fetch(WEB_APP_URL);
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const data = await res.json();

      // Support either {items:[...]} or {success:true, items:[...]}
      ALL_ITEMS = (data && data.items) ? data.items : [];

      renderTodos();
    } catch (err) {
      console.error('Failed to load todos:', err);
      showError(true);
      ALL_ITEMS = [];
      renderTodos();
    } finally {
      setLoading(false);
    }
  }

  function applyFilters() {
    let list = [...ALL_ITEMS];

    const search = LAST_SEARCH.trim().toLowerCase();
    if (search) {
      list = list.filter(item => {
        const name  = (item.name || '').toLowerCase();
        const phone = (item.phone || '').toLowerCase();
        const desc  = (item.itemDescription || '').toLowerCase();
        return (
          name.includes(search) ||
          phone.includes(search) ||
          desc.includes(search)
        );
      });
    }

    if (SHOW_OPEN_ONLY) {
      list = list.filter(item => {
        const out = normalizeBool(item.orderOutTheDoor);
        const completed = normalizeBool(item.completed);
        return !(out || completed);
      });
    }

    return list;
  }

  function renderTodos() {
    const container = document.getElementById('todoList');
    if (!container) return;
    container.innerHTML = '';

    const items = applyFilters();

    if (!items.length) {
      const div = document.createElement('div');
      div.className = 'list-empty';
      div.innerHTML = `
        <strong>No matching items.</strong><br/>
        Adjust filters or check if any orders/services are open.
      `;
      container.appendChild(div);
      return;
    }

    items.forEach(item => {
      const card = document.createElement('div');
      card.className = 'card';
      card.dataset.id = item.id || '';
      card.dataset.sourceSheet = item.sourceSheet || '';

      const sourceName = (item.sourceSheet || '').toLowerCase();
      const isService = sourceName === 'service tracker';

      const paid      = normalizeBool(item.customerPaid);
      const out       = normalizeBool(item.orderOutTheDoor);
      const called    = normalizeBool(item.hasBeenCalled);
      const completed = normalizeBool(item.completed);

      const overdue = isOverdue(item.orderDue);

            const name     = item.name || 'Unknown';
      const phone    = item.phone || '';
      const desc     = item.itemDescription || (isService ? 'Service' : 'Order');
      const loc      = item.location || '';

      const dueRaw   = item.orderDue || '';
      const dateRaw  = item.orderDate || '';
      const due      = formatDateDisplay(dueRaw);
      const date     = formatDateDisplay(dateRaw);

      const staff    = item.staffMember || '';

      const sourceLabel = isService ? 'Service' : 'Order';

      card.innerHTML = `
        <div class="card-header-row">
          <div class="card-title-block">

            <div class="card-name-row">
              <div class="card-name">${name}</div>

              <div class="badge-inline">
                <span class="status-badge ${paid ? 'on' : 'off'}" data-type="paid">
                  <span class="status-dot"></span>
                  ${paid ? 'Paid' : 'Unpaid'}
                </span>

                ${isService ? `
                <span class="status-badge ${completed ? 'on' : 'off'}" data-type="completed">
                  <span class="status-dot"></span>
                  ${completed ? 'Completed' : 'Not Completed'}
                </span>
                ` : ''}

                <span class="status-badge ${called ? 'on' : 'off'}" data-type="called">
                  <span class="status-dot"></span>
                  ${called ? 'Called' : 'Not Called'}
                </span>
              </div>
            </div>

            <div class="card-phone">${phone}</div>

            <div class="card-tag-col">
              <span class="chip chip-type">${sourceLabel}</span>
              <span class="chip chip-due ${overdue && !completed ? 'chip-due-late' : ''}">
                <span class="chip-dot"></span>
                ${due ? `Due ${due}` : 'No due date'}
              </span>
            </div>

          </div>
        </div>

        <div class="card-body">
          <div class="item-desc">${desc}</div>
          <div class="meta-row">
            ${loc ? `<span class="meta-pill">üìç ${loc}</span>` : ''}
            ${date ? `<span class="meta-pill">üïí ${date}</span>` : ''}
            ${staff ? `<span class="meta-pill">üë§ ${staff}</span>` : ''}
          </div>
        </div>

        <div class="card-footer-row">
          <div class="btn-row">
            <button class="btn-ghost btn-wide" type="button" data-action="edit">
              Edit
            </button>
            <button class="btn-ghost btn-wide" type="button" data-action="schedule">
              Schedule Apt
            </button>
            <button class="btn-ghost btn-ghost-danger btn-wide" type="button" data-action="pickedUp">
              Picked Up
            </button>
          </div>
        </div>
      `;

      container.appendChild(card);
    });
  }

  function updateLocalItemFlag(id, fieldKey, value) {
    for (let i = 0; i < ALL_ITEMS.length; i++) {
      if ((ALL_ITEMS[i].id || '').toString() === id.toString()) {

        if (fieldKey === 'paid') {
          ALL_ITEMS[i].customerPaid = value;
        } else if (fieldKey === 'called') {
          ALL_ITEMS[i].hasBeenCalled = value;
        } else if (fieldKey === 'completed') {
          ALL_ITEMS[i].completed = value;
        } else if (fieldKey === 'out') {
          ALL_ITEMS[i].orderOutTheDoor = value;
        }

        break;
      }
    }
  }

  async function sendFlagUpdate(id, fieldKey, value) {
    try {
      await fetch(WEB_APP_URL, {
        method: 'POST',
        mode: 'no-cors',
        headers: {
          'Content-Type': 'text/plain;charset=utf-8'
        },
        body: JSON.stringify({
          action: 'updateFlag',
          id,
          fieldKey,
          value
        })
      });
    } catch (err) {
      console.error('Failed to update flag:', err);
    }
  }

  function handleBadgeClick(badgeEl) {
    const card = badgeEl.closest('.card');
    if (!card) return;

    const id = card.dataset.id;
    if (!id) return;

    const fieldKey = badgeEl.dataset.type;
    if (!fieldKey) return;

    const isOn = badgeEl.classList.contains('on');
    const newVal = isOn ? 'N' : 'Y';

    // Toggle classes
    badgeEl.classList.toggle('on', !isOn);
    badgeEl.classList.toggle('off', isOn);

    // Update label text
    if (fieldKey === 'paid') {
      badgeEl.innerHTML = `<span class="status-dot"></span>${!isOn ? 'Paid' : 'Unpaid'}`;
    } else if (fieldKey === 'completed') {
      badgeEl.innerHTML = `<span class="status-dot"></span>${!isOn ? 'Completed' : 'Not Completed'}`;
    } else if (fieldKey === 'called') {
      badgeEl.innerHTML = `<span class="status-dot"></span>${!isOn ? 'Called' : 'Not Called'}`;
    }

    updateLocalItemFlag(id, fieldKey, newVal);
    sendFlagUpdate(id, fieldKey, newVal);
  }

  function handleButtonClick(btnEl) {
    const action = btnEl.dataset.action;
    const card = btnEl.closest('.card');
    if (!card) return;

    const id = card.dataset.id;
    if (!id) return;

    if (action === 'pickedUp') {
      // Mark this item as "Out The Door"
      const newVal = 'Y';

      updateLocalItemFlag(id, 'out', newVal);
      sendFlagUpdate(id, 'out', newVal);

      // Re-render so it's removed when showing Open Only
      renderTodos();

    } else if (action === 'schedule') {
      const item = findItemById(id);
      if (item) {
        openApptModal(item);
      }
    } else if (action === 'edit') {
      alert('Edit: open the sheet or add a modal here.');
    }
  }

    function findItemById(id) {
    return ALL_ITEMS.find(it => (it.id || '').toString() === (id || '').toString());
  }

  function openApptModal(item) {
    CURRENT_APPT_ITEM = item || null;
    const modal = document.getElementById('apptModal');
    if (!modal || !item) return;

    // Pre-fill from the card data
    document.getElementById('apptName').value     = item.name || '';
    document.getElementById('apptPhone').value    = item.phone || '';
    document.getElementById('apptService').value  = item.itemDescription || '';
    document.getElementById('apptLocation').value = item.location || '';

    document.getElementById('apptDate').value = '';
    document.getElementById('apptTime').value = '';

    modal.classList.add('show');
  }

  function closeApptModal() {
    const modal = document.getElementById('apptModal');
    if (!modal) return;
    modal.classList.remove('show');
    CURRENT_APPT_ITEM = null;
  }

  async function saveAppointment() {
    if (!CURRENT_APPT_ITEM) {
      closeApptModal();
      return;
    }

    const name     = document.getElementById('apptName').value.trim()     || CURRENT_APPT_ITEM.name || '';
    const phone    = document.getElementById('apptPhone').value.trim()    || CURRENT_APPT_ITEM.phone || '';
    const service  = document.getElementById('apptService').value.trim()  || CURRENT_APPT_ITEM.itemDescription || '';
    const location = document.getElementById('apptLocation').value.trim() || CURRENT_APPT_ITEM.location || '';
    const apptDate = document.getElementById('apptDate').value;
    const apptTime = document.getElementById('apptTime').value.trim();

    try {
      await fetch(WEB_APP_URL, {
        method: 'POST',
        mode: 'no-cors',
        headers: {
          'Content-Type': 'text/plain;charset=utf-8'
        },
        body: JSON.stringify({
          action: 'createAppointment',
          name,
          phone,
          service,
          location,
          apptDate,
          apptTime
        })
      });

      alert('Appointment saved to Appointments sheet.');
      closeApptModal();
    } catch (err) {
      console.error('Failed to save appointment:', err);
      alert('Could not save appointment.');
    }
  }


  function setupInteractions() {
    const list = document.getElementById('todoList');
    if (list) {
      list.addEventListener('click', (e) => {
        const badge = e.target.closest('.status-badge');
        if (badge) {
          handleBadgeClick(badge);
          return;
        }

        const btn = e.target.closest('button[data-action]');
        if (btn) {
          handleButtonClick(btn);
          return;
        }
      });
    }

    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
      searchInput.addEventListener('input', (e) => {
        LAST_SEARCH = e.target.value;
        renderTodos();
      });
    }

    const filterOpenBtn = document.getElementById('filterOpenBtn');
    if (filterOpenBtn) {
      filterOpenBtn.addEventListener('click', () => {
        SHOW_OPEN_ONLY = !SHOW_OPEN_ONLY;
        filterOpenBtn.classList.toggle('filter-pill-active', SHOW_OPEN_ONLY);
        filterOpenBtn.textContent = SHOW_OPEN_ONLY ? 'Open Only' : 'All Items';
        renderTodos();
      });
    }

        // Modal wiring
    const modal = document.getElementById('apptModal');
    if (modal) {
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          closeApptModal();
        }
      });
    }

    const apptClose  = document.getElementById('apptClose');
    const apptCancel = document.getElementById('apptCancel');
    const apptSave   = document.getElementById('apptSave');

    if (apptClose)  apptClose.addEventListener('click', closeApptModal);
    if (apptCancel) apptCancel.addEventListener('click', closeApptModal);
    if (apptSave)   apptSave.addEventListener('click', saveAppointment);


  }

  document.addEventListener('DOMContentLoaded', () => {
    setupInteractions();
    loadTodosFromServer();
  });
</script>


</body>
